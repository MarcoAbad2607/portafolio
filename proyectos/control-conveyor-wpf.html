<!doctype html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Conveyor ‚Äî Interlock de entrada por trazabilidad</title>
  <meta name="description" content="Caso completo: Control de Conveyor mediante interlock de entrada, validando trazabilidad y estatus antes de permitir el paso de piezas/paneles." />
  <meta name="theme-color" content="#f8fafc" id="themeColor">
  <link rel="icon" href="../img/favicon.ico">
  <style>
    /* =========== Paleta base =========== */
    :root{
      --bg:#f8fafc; --panel:#ffffff; --ink:#0b1220; --muted:#475569; --line:#cbd5e1;
      --acc:#22d3ee; --acc-2:#a78bfa; --warn:#f59e0b; --ok:#34d399;
      --btn-copy-bg:#0f172a; --btn-copy-ink:#e6edf3; --code-bg:#0b1220; --code-ink:#e6edf3;
      --chip-bg:#eef2ff; --chip-ink:#1e293b;
    }
    html[data-theme="dark"]{
      --bg:#0b1220; --panel:#0f172a; --ink:#e6edf3; --muted:#98a2b3; --line:#22314c;
      --btn-copy-bg:#1f2937; --btn-copy-ink:#e5e7eb; --code-bg:#0a0f1a; --code-ink:#e6edf3;
      --chip-bg:#111827; --chip-ink:#e5e7eb;
    }

    *{box-sizing:border-box}
    html{height:100%;scroll-behavior:smooth}
    body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    a{color:var(--acc);text-decoration:none} a:hover{text-decoration:underline}
    img{max-width:100%;display:block}
    .wrap{max-width:1200px;margin:0 auto;padding:0 20px}

    /* Header */
    header{position:sticky;top:0;z-index:50;background:rgba(248,250,252,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    html[data-theme="dark"] header{ background:rgba(11,18,32,.6); }
    nav{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,var(--acc),var(--acc-2))}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--acc);color:#05131e;font-weight:700;border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
    .mode{background:transparent;border:1px solid var(--line);color:var(--ink);padding:6px 10px;border-radius:10px;margin-left:8px;cursor:pointer}

    /* Chips */
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--chip-bg);color:var(--chip-ink);font-size:12.5px}

    /* Hero */
    .hero{position:relative;overflow:hidden}
    .hero .inner{display:grid;gap:24px;grid-template-columns:1.1fr .9fr;align-items:center;padding:36px 0 12px}
    .title{font-size:clamp(28px,4.5vw,48px);line-height:1.1;margin:0}
    .lead{color:var(--muted);margin:0}
    .cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .blob{position:absolute;inset:-20% auto auto -10%;width:60vw;height:60vw;filter:blur(80px);background:
      radial-gradient(circle at 30% 30%,rgba(34,211,238,.25),transparent 60%),
      radial-gradient(circle at 70% 60%,rgba(167,139,250,.22),transparent 60%);pointer-events:none}
    .avatar{width:140px;height:140px;border-radius:12px;border:2px solid var(--line);background:#0b1220;margin-left:auto;object-fit:cover}

    /* Secciones */
    section{padding:28px 0;scroll-margin-top:80px}
    h2{font-size:22px;margin:0 0 12px}
    .muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    .cards{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden;position:relative}

    /* Galer√≠a (contain) */
    .thumb{width:100%;height:clamp(200px, 28vw, 320px);display:grid;place-items:center;background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.04))}
    html[data-theme="dark"] .thumb{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.06)); }
    .thumb img{width:100%;height:100%;object-fit:contain;object-position:center}
    .view-full{position:absolute;right:10px;bottom:10px;padding:6px 10px;font-size:12.5px;border-radius:10px;border:1px solid var(--line);background:rgba(15,23,42,.65);color:#fff;backdrop-filter:blur(4px);display:inline-flex;gap:6px;align-items:center;opacity:0;transform:translateY(4px);transition:.2s ease;cursor:pointer}
    .card:hover .view-full{opacity:1;transform:none}

    /* Breadcrumb */
    .crumbs{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:12px 0}
    .crumbs a, .crumbs span[aria-current="page"]{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid var(--line);background:var(--chip-bg);color:var(--chip-ink);text-decoration:none}
    .crumbs .sep{opacity:.5;color:var(--muted);padding:0 2px}

    /* C√≥digo */
    pre{position:relative;margin:0;padding:14px;border:1px solid var(--line);background:var(--code-bg);border-radius:12px;overflow:auto;padding-top:38px}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;color:var(--code-ink);font-size:13.5px;white-space:pre}
    .copy{position:absolute;right:8px;top:8px;padding:7px 10px;border-radius:8px;border:1px solid var(--line);background:var(--btn-copy-bg);color:var(--btn-copy-ink);cursor:pointer;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.25)}

    /* Procedimiento */
    .steps{display:grid;grid-template-columns:1fr;gap:16px;width:100%;margin:0;box-sizing:border-box}
    .step{position:relative;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-sizing:border-box;overflow:hidden}
    .step::before{content:attr(data-step);position:absolute;left:16px;top:16px;width:28px;height:28px;border-radius:999px;display:grid;place-items:center;font-weight:700;background:linear-gradient(90deg,var(--acc),var(--acc-2));color:#05131e}
    .step h3{margin:0 0 8px 44px}

    /* Footer & toTop */
    footer{padding:28px 0 48px;color:var(--muted);border-top:1px solid var(--line)}
    #toTop{position:fixed;right:16px;bottom:16px;display:none;align-items:center;gap:6px;padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(15,23,42,.75);color:#fff}

    /* Lightbox */
    dialog#lightbox{border:none;padding:0;margin:0;width:min(96vw,1200px);max-width:96vw;background:transparent}
    dialog#lightbox::backdrop{background:rgba(0,0,0,.65);backdrop-filter:blur(2px)}
    .lb-wrap{position:relative;background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .lb-toolbar{position:absolute;top:8px;right:8px;display:flex;gap:8px}
    .lb-btn{background:rgba(15,23,42,.8);color:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
    .lb-img{width:100%;height:80vh;max-height:80vh;object-fit:contain;background:#000}
    .lb-caption{padding:10px 12px;font-size:13px;color:var(--muted);border-top:1px solid var(--line);background:var(--panel)}

    /* Responsive */
    @media (max-width: 900px){.hero .inner{grid-template-columns: 1fr; padding:24px 0 8px;} .avatar{margin:12px auto 0} .cards{grid-template-columns:1fr} .steps{gap:12px} .step{padding:12px} .step::before{top:12px; left:12px; width:26px; height:26px;} .step h3{margin:0 0 8px 44px} pre{padding:10px;border-radius:8px} code{font-size:12.5px;white-space:pre-wrap;word-break:break-word} .copy{padding:6px 9px; font-size:12px; right:6px; top:6px} }
    @media (max-width: 380px){ .step{ padding-left:12px;} .step::before{ width:24px; height:24px; font-size:13px;} code{ font-size:12px;} }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrap">
      <nav>
        <div class="brand"><span class="dot"></span> <span>Marco A. Mu√±iz ‚Äî Proyecto</span></div>
        <div style="display:flex;align-items:center;gap:8px">
          <a class="btn ghost" href="../index.html#proyectos">‚Üê Volver</a>
          <button id="mode" class="mode" aria-label="Tema">‚òº</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <div class="hero">
    <div class="blob" aria-hidden="true"></div>
    <div class="wrap inner">
      <div>
        <span class="chip">Proyecto</span>
        <h1 class="title">Control de Conveyor ‚Äî Interlock de entrada</h1>
        <p class="lead">Bloqueo/permiso autom√°tico del conveyor de entrada con base en <strong>trazabilidad</strong> y <strong>estatus</strong> de la pieza/panel. Si no cumple, no entra.</p>
        <div class="cta">
          <a class="btn" href="../index.html#proyectos">‚Üê Volver</a>
          <a class="btn ghost" href="#procedimiento">Ver procedimiento</a>
        </div>
      </div>
      <div>
        <img class="avatar" loading="lazy" decoding="async" alt="Imagen representativa del proyecto Control de Conveyor" src="../img/interlock-conveyor-main.png" />
      </div>
    </div>
  </div>

  <!-- Aviso + Breadcrumb -->
  <div class="wrap" style="margin-top:10px">
    <div class="panel" style="margin-bottom:20px; border-left:4px solid var(--warn); background:rgba(245,158,11,.08)">
      <p style="margin:0; font-size:14.5px; line-height:1.5; color:var(--muted)">üîí <strong>Aviso:</strong> Parte de la informaci√≥n t√©cnica y de negocio ha sido <u>omitida</u> por motivos de confidencialidad y derechos de propiedad intelectual.</p>
    </div>
    <nav class="crumbs" aria-label="breadcrumb">
      <a href="../index.html">Inicio</a>
      <span class="sep">‚Ä∫</span>
      <a href="../index.html#proyectos">Proyectos</a>
      <span class="sep">‚Ä∫</span>
      <span aria-current="page">Control de Conveyor</span>
    </nav>
  </div>

  <!-- Contenido principal -->
  <main class="wrap">
    <!-- Resumen -->
    <section>
      <h2>Resumen</h2>
      <div class="panel">
        <p>
          Varias estaciones no pod√≠an controlar el conveyor de entrada; piezas sin trazabilidad o con <em>FAIL</em> entraban de todos modos, provocando problemas aguas abajo (p. ej. panel cortado en <em>router</em> que ya no pod√≠a procesarse individualmente) e incluso <strong>scrap</strong>.
        </p>
        <p>
          Implement√© un <strong>interlock</strong> entre PC y controlador del conveyor (serial) que solo permite el paso cuando el servicio de trazabilidad valida la pieza/panel. Si la validaci√≥n es negativa o incompleta, el conveyor permanece bloqueado y se gu√≠a al operador.
        </p>
        <div class="row" style="margin-top:8px">
          <span class="tag">C# (.NET WinForms)</span>
          <span class="tag">Arduino/Serial</span>
          <span class="tag">TCP/IP Keyence</span>
          <span class="tag">MES/IMES</span>
          <span class="tag">Trazabilidad</span>
        </div>
      </div>
    </section>

    <!-- Procedimiento realizado -->
    <section id="procedimiento">
      <h2>Procedimiento realizado</h2>
      <div class="steps">
        <!-- Paso 1 -->
        <article class="step" data-step="1">
          <h3>Requisitos y reglas de negocio</h3>
          <p class="muted">No permitir entrada si la pieza/panel no tiene <strong>SN v√°lido</strong>, si est√° en estado <em>FAIL</em>, <em>SCRAP</em> o si ya pertenece a una estaci√≥n posterior (<em>Next Station</em>).</p>
          <ul>
            <li>Modos: <code>0=Desactivado</code>, <code>1=Panel</code>, <code>2=Individual</code>.</li>
            <li>Lectura: esc√°ner Keyence (autom√°tico) o captura manual (fallback).</li>
            <li>Mensajes claros al operador y bloqueo f√≠sico del conveyor.</li>
          </ul>
        </article>

        <!-- Paso 2 -->
        <article class="step" data-step="2">
          <h3>Protocolo de comandos PC ‚áÑ Controlador</h3>
          <p class="muted">Mensajes por puerto serie para sincronizar detecci√≥n, autorizaci√≥n y retiro.</p>
          <pre><button class="copy" data-copy>Copiar</button><code>Host ‚Üí Ctrl: REINICIAR | PASS FORZADO | PIEZA OK | PIEZA NG | STATUS
Ctrl ‚Üí Host: PONG (tras PING), PIEZA DETECTADA, ACK/NAK &lt;cmd&gt;, HB
Estados Ctrl: IDLE ‚Üí WAIT_RESPONSE ‚Üí (OK) WAIT_PIECE_REMOVAL ‚Üí IDLE / (NG) WAIT_REMOVE ‚Üí IDLE</code></pre>
        </article>

        <!-- Paso 3 -->
        <article class="step" data-step="3">
          <h3>Evento de detecci√≥n y ciclo en PC</h3>
          <p class="muted">Al recibir <code>PIEZA DETECTADA</code> se valida trazabilidad y se decide el paso.</p>
          <pre><button class="copy" data-copy>Copiar</button><code>// DataReceived ‚Üí disparo del ciclo (protecci√≥n reentrante)
this.BeginInvoke(new Action(async () => {
  if (!await _gate.WaitAsync(0)) return; // otro ciclo en curso
  try {
    await BtnCargar_ClickAsync(); // valida SN ‚Üí servicio ‚Üí decide OK/NG
  } finally { _gate.Release(); }
}));</code></pre>
        </article>

        <!-- Paso 4 -->
        <article class="step" data-step="4">
          <h3>Decisi√≥n: autorizaci√≥n o bloqueo</h3>
          <p class="muted">Resultado de la validaci√≥n contra el servicio de trazabilidad.</p>
          <pre><button class="copy" data-copy>Copiar</button><code>if (status) {
  SendPiezaOk();   // Host ‚Üí Ctrl: PIEZA OK (activa rel√© y deja pasar)
  Status.Text = "PASS: enviado a l√≠nea";
} else {
  SendPiezaNg();   // Host ‚Üí Ctrl: PIEZA NG (bloquea, espera retiro)
  Status.Text = $"FAIL: {message}";
}</code></pre>
        </article>

        <!-- Paso 5 -->
        <article class="step" data-step="5">
          <h3>Lectura Keyence con disparo seguro</h3>
          <p class="muted">Disparo <code>LON/LOFF</code> y lectura tolerante a CR/LF, con excepci√≥n si no hay dato.</p>
          <pre><button class="copy" data-copy>Copiar</button><code>private async Task&lt;string&gt; TriggerScannerAsync(){
  using var tcp = new TcpClient();
  await tcp.ConnectAsync(ScannerIP, ScannerPort);
  using var s = tcp.GetStream(); s.ReadTimeout = 5000;
  async Task W(string c){ var b=Encoding.ASCII.GetBytes(c+"\r"); await s.WriteAsync(b,0,b.Length);}  
  await W("LON");
  var sb=new StringBuilder(); var buf=new byte[256]; var t0=DateTime.UtcNow;
  while((DateTime.UtcNow-t0).TotalMilliseconds<5000){
    if(s.DataAvailable){ int n=await s.ReadAsync(buf,0,buf.Length); if(n>0) sb.Append(Encoding.ASCII.GetString(buf,0,n)); if(sb.ToString().Contains("\n")||sb.ToString().Contains("\r")) break; }
    await Task.Delay(5);
  }
  await W("LOFF");
  var resp=sb.ToString().Trim(); if(string.IsNullOrWhiteSpace(resp) || resp=="ERROR")
    throw new InvalidOperationException("Esc√°ner sin dato v√°lido");
  return resp;
}</code></pre>
        </article>

        <!-- Paso 6 -->
        <article class="step" data-step="6">
          <h3>Sketch del controlador (Arduino)</h3>
          <p class="muted">M√°quina de estados con <em>timeout</em> en espera de respuesta y antirrebote.</p>
          <pre><button class="copy" data-copy>Copiar</button><code>// Estados: IDLE ‚Üí WAIT_RESPONSE ‚Üí WAIT_PIECE_REMOVAL / WAIT_REMOVE
// Comandos: REINICIAR, PASS FORZADO, PIEZA OK, PIEZA NG, STATUS
// (versi√≥n resumida, sin datos sensibles)
if (cmd == "REINICIAR") { forcedPassMode=false; relayOff(); state=IDLE; }
else if (cmd == "PASS FORZADO") { forcedPassMode=true; relayOn(); }
...
if (state==IDLE && pieceArrived) { Serial.println("PIEZA DETECTADA"); state=WAIT_RESPONSE; t0=millis(); }
if (state==WAIT_RESPONSE && millis()-t0>TIMEOUT) { relayOff(); state=WAIT_REMOVE; Serial.println("TIMEOUT"); }</code></pre>
        </article>

        <!-- Paso 7 -->
        <article class="step" data-step="7">
          <h3>Modos de operaci√≥n y diagn√≥stico</h3>
          <p class="muted">Conmutaci√≥n <em>Autom√°tico/Manual</em>, <em>Panel/Individual</em>; diagn√≥stico via <code>STATUS</code> y UI protegida por credenciales. Se omiten nombres de cliente, rutas internas y SN reales.</p>
          <ul>
            <li><strong>Autom√°tico</strong>: esc√°ner Keyence; <strong>Manual</strong>: captura por operador.</li>
            <li><strong>Panel</strong>: valida SN padre y deriva SNs hijo; <strong>Individual</strong>: valida pieza suelta.</li>
            <li><strong>Diagn√≥stico</strong>: <code>STATUS</code> reporta sensor/rel√©/estado.</li>
          </ul>
        </article>

        
      </div>
    </section>

    <!-- Galer√≠a (im√°genes gen√©ricas; reemplaza por las tuyas) -->
    <section>
      <h2>Galer√≠a</h2>
      <div class="grid cards" id="galeria">
        <div class="card">
          <div class="thumb"><img loading="lazy" decoding="async" src="../img/interlock-conveyor-captura1.png" alt="UI de interlock"></div>
          <button class="view-full" data-full="../img/interlock-conveyor-captura1.png">üîé Ver completa</button>
        </div>
        <div class="card">
          <div class="thumb"><img loading="lazy" decoding="async" src="../img/interlock-conveyor-captura2.png" alt="Flujo de estados"></div>
          <button class="view-full" data-full="../img/interlock-conveyor-captura2.png">üîé Ver completa</button>
        </div>
        <div class="card">
          <div class="thumb"><img loading="lazy" decoding="async" src="../img/interlock-conveyor-captura3.png" alt="Comandos serial"></div>
          <button class="view-full" data-full="../img/interlock-conveyor-captura3.png">üîé Ver completa</button>
        </div>
		<div class="card">
          <div class="thumb"><img loading="lazy" decoding="async" src="../img/interlock-conveyor-captura4.jpg" alt="Diseno PCB"></div>
          <button class="view-full" data-full="../img/interlock-conveyor-captura4.jpg">üîé Ver completa</button>
        </div>
		<div class="card">
          <div class="thumb"><img loading="lazy" decoding="async" src="../img/interlock-conveyor-captura5.jpg" alt="Diagrama"></div>
          <button class="view-full" data-full="../img/interlock-conveyor-captura5.jpg">üîé Ver completa</button>
        </div>
		<div class="card">
          <div class="thumb"><img loading="lazy" decoding="async" src="../img/interlock-conveyor-captura6.jpg" alt="Instalacion"></div>
          <button class="view-full" data-full="../img/interlock-conveyor-captura6.jpg">üîé Ver completa</button>
        </div>
		<div class="card">
          <div class="thumb"><img loading="lazy" decoding="async" src="../img/interlock-conveyor-captura7.jpg" alt="Instalacion"></div>
          <button class="view-full" data-full="../img/interlock-conveyor-captura7.jpg">üîé Ver completa</button>
        </div>
      </div>
    </section>

    <!-- Detalles t√©cnicos -->
    <section>
      <h2>Detalles t√©cnicos</h2>
      <div class="panel">
        <ul>
          <li><strong>Lenguajes/Frameworks:</strong> C# (.NET WinForms) para la estaci√≥n; Arduino/C++ para el controlador.</li>
          <li><strong>Integraciones:</strong> REST con sistema de trazabilidad (MES/IMES); TCP/IP con esc√°ner Keyence (LON/LOFF); Serial UART con el controlador; archivos JSON para configuraci√≥n.</li>
          <li><strong>Protocolo y seguridad:</strong> comandos <code>REINICIAR</code>, <code>PASS FORZADO</code>, <code>PIEZA OK</code>, <code>PIEZA NG</code>, <code>STATUS</code>; <em>ACK/NAK</em> y <em>heartbeat</em>; <em>timeout</em> en espera de respuesta; antirrebote de sensor; <em>fail‚Äësafe</em> con rel√© en HIGH al iniciar.</li>
          <li><strong>Modos:</strong> Autom√°tico (esc√°ner) / Manual (captura); 0 = Desactivado, 1 = Panel (deriva SN hijos), 2 = Individual.</li>
          <li><strong>Diagn√≥stico y hardening:</strong> login para cambios cr√≠ticos; <code>STATUS</code> expone sensor/rel√©/estado; reconexi√≥n de COM; PING/PONG para detectar el puerto.</li>
        </ul>
      </div>
    </section>

    <!-- Resultados -->
    <section>
      <h2>Resultados</h2>
      <div class="panel">
        <ul>
          <li><strong>0%</strong> de entradas sin trazabilidad/estatus v√°lido en estaciones con interlock.</li>
          <li>Reducci√≥n de reprocesos por paneles mal enrutados y menor riesgo de <em>scrap</em>.</li>
          <li>Gu√≠a clara al operador (mensajes/colores) y trazabilidad consistente por estaci√≥n.</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- toTop -->
  <div id="toTop">‚ñ≤ Arriba</div>

  <!-- Lightbox -->
  <dialog id="lightbox" aria-label="Visor de imagen completa">
    <div class="lb-wrap">
      <div class="lb-toolbar">
        <a class="lb-btn" id="lb-download" download>‚¨á Descargar</a>
        <button class="lb-btn" id="lb-close" aria-label="Cerrar">‚úï</button>
      </div>
      <img class="lb-img" id="lb-img" alt="">
      <div class="lb-caption" id="lb-caption"></div>
    </div>
  </dialog>

  <!-- Footer -->
  <footer>
    <div class="wrap">¬© <span id="year"></span> Marco Antonio Mu√±iz Abad ¬∑ Hecho con HTML/CSS/JS ¬∑ Publicado en GitHub Pages</div>
  </footer>

  <script>
    // A√±o din√°mico
    document.getElementById('year').textContent = new Date().getFullYear();

    // Tema claro/oscuro
    const modeBtn = document.getElementById('mode');
    const themeMeta = document.getElementById('themeColor');
    function applyTheme(isDark){
      document.documentElement.dataset.theme = isDark ? 'dark' : 'light';
      if (modeBtn) modeBtn.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
      if (themeMeta) themeMeta.setAttribute('content', isDark ? '#0b1220' : '#f8fafc');
    }
    (function initTheme(){
      const saved = localStorage.getItem('theme');
      const isDark = saved ? (saved === 'dark') : false;
      applyTheme(isDark);
    })();
    if (modeBtn){
      modeBtn.addEventListener('click', ()=>{
        const nowDark = (document.documentElement.dataset.theme !== 'dark');
        applyTheme(nowDark);
        localStorage.setItem('theme', nowDark ? 'dark' : 'light');
      });
    }

    // Copiar c√≥digo
    document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const code = btn.nextElementSibling?.innerText || '';
        navigator.clipboard.writeText(code).then(()=>{
          const old = btn.textContent; btn.textContent = '¬°Copiado!'; setTimeout(()=> btn.textContent = old, 1200);
        });
      });
    });

    // To top
    const toTop = document.getElementById('toTop');
    window.addEventListener('scroll', ()=>{ toTop.style.display = window.scrollY > 500 ? 'inline-flex' : 'none'; });
    toTop.addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));

    // Lightbox galer√≠a
    const lightbox = document.getElementById('lightbox');
    const lbImg = document.getElementById('lb-img');
    const lbCaption = document.getElementById('lb-caption');
    const lbClose = document.getElementById('lb-close');
    const lbDownload = document.getElementById('lb-download');

    function openLightbox(src, alt){
      lbImg.src = src; lbImg.alt = alt || ''; lbCaption.textContent = alt || '';
      lbDownload.href = src; lbDownload.setAttribute('download', (alt || 'imagen') + '.png');
      if (typeof lightbox.showModal === 'function') lightbox.showModal(); else lightbox.setAttribute('open','');
    }
    function closeLightbox(){ if (typeof lightbox.close === 'function') lightbox.close(); else lightbox.removeAttribute('open'); lbImg.src = ''; }

    document.getElementById('galeria').addEventListener('click', (e)=>{
      const card = e.target.closest('.card'); if (!card) return;
      const img = card.querySelector('.thumb img'); const btn = e.target.closest('.view-full');
      if (img && (e.target === img || btn)) { const src = btn?.dataset.full || img.currentSrc || img.src; openLightbox(src, img.alt || 'Imagen'); }
    });
    lbClose.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (e)=>{ if (e.target === lightbox) closeLightbox(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && lightbox.open) closeLightbox(); });
  </script>
</body>
</html>
